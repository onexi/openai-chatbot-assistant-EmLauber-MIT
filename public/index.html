<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenAI Chatbot</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #343a40;
      color: white;
    }
    .user-message {
      color: #007bff;
    }
    .assistant-message {
      color: #28a745;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center">OpenAI Chatbot</h1>
    <div class="card bg-dark text-white">
      <div class="card-body">
        <div id="messages" class="mb-3" style="height: 300px; overflow-y: scroll;"></div>
        <form id="chat-form">
          <div class="input-group">
            <input type="text" id="user-input" class="form-control" placeholder="Ask a question...">
            <div class="input-group-append">
              <button class="btn btn-primary" type="submit">Send</button>
            </div>
          </div>
        </form>
        <div class="mt-3">
          <button id="show-assistant-id" class="btn btn-secondary">Show Assistant ID</button>
          <button id="show-assistant-name" class="btn btn-secondary">Show Assistant Name</button>
          <button id="show-state" class="btn btn-secondary">Show State</button>
        </div>
        <div id="info" class="mt-3"></div>
      </div>
    </div>
  </div>
  <script>
    document.getElementById('chat-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const userInput = document.getElementById('user-input').value;
      if (!userInput) return;

      // Add user message to the state and display it
      addMessage('user', userInput);

      // Send user message to the server
      await fetch('/api/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ role: 'user', content: userInput }),
      });

      // Run the assistant
      await fetch('/api/run', {
        method: 'POST',
      });

      // Poll for the assistant's response
      let assistantMessage = null;
      while (!assistantMessage) {
        const response = await fetch('/api/messages');
        const messages = await response.json();
        assistantMessage = messages.find(msg => msg.role === 'assistant');
        if (!assistantMessage) {
          await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for 1 second before polling again
        }
      }

      // Display the assistant's response
      addMessage('assistant', assistantMessage.content);
    });

    function addMessage(role, content) {
      const messagesDiv = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.classList.add(role === 'user' ? 'user-message' : 'assistant-message');
      messageDiv.textContent = content;
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    document.getElementById('show-assistant-id').addEventListener('click', () => {
      displayInfo(`Assistant ID: ${state.assistant_id}`);
    });

    document.getElementById('show-assistant-name').addEventListener('click', () => {
      displayInfo(`Assistant Name: ${state.assistant_name}`);
    });

    document.getElementById('show-state').addEventListener('click', () => {
      displayInfo(`State: ${JSON.stringify(state, null, 2)}`);
    });

    function displayInfo(info) {
      const infoDiv = document.getElementById('info');
      infoDiv.textContent = info;
    }

    // State dictionary
    const state = {
      assistant_id: 'asst_mKubPnoRJxz3sL90FRE9NEZH',
      assistant_name: 'BankTest',
      threadId: null,
      messages: [],
    };
  </script>
</body>
</html>